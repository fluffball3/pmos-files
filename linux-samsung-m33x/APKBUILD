# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/(CHANGEME!)

pkgname=linux-samsung-m33x
pkgver=5.10.234
pkgrel=0
pkgdesc="Samsung Galaxy M33 5G kernel"
arch="aarch64"
_carch="arm64"
_flavor="samsung-m33x"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	findutils
	flex
	openssl-dev
	perl
	xz
	cpio
	python3
	linux-headers
"
#	clang
#	llvm
#	lld

# Compiler: this kernel was only tested with GCC6. Feel free to make a merge
# request if you find out that it is booting working with newer GCCs as
# well. See <https://postmarketos.org/vendorkernel> for instructions.
#if [ "${CC:0:5}" != "gcc6-" ]; then
#	CC="gcc6-$CC"
#	HOSTCC="gcc6-gcc"
#	CROSS_COMPILE="gcc6-$CROSS_COMPILE"
#fi

# Source
_repository="android_kernel_samsung_m33x"
_commit="9c64f7aa866dca5a50dda6bd554601e80cf800e8"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/fluffball3/$_repository/archive/$_commit.tar.gz
	$_config
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	REPLACE_GCCH=0
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
#	export CC="clang"
#	export HOSTCC="clang"
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" PLATFORM_VERSION=12 TARGET_SOC=s5e8825 \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
	cp $_outdir/arch/$_carch/boot/Image.gz $_outdir/arch/$_carch/boot/Image
}

package() {
	KERNEL_IMAGE_NAME="Image" downstreamkernel_package \
		"$builddir" "$pkgdir" "$_carch" "$_flavor" "$_outdir"

	make dtbs_install O="$_outdir" ARCH="$_carch" \
		INSTALL_DTBS_PATH="$pkgdir/boot/dtbs"

	make modules_install O="$_outdir" ARCH="$_carch" INSTALL_MOD_STRIP="--strip-debug" \
		INSTALL_MOD_PATH="$pkgdir"
}

sha512sums="
c3d9a02490eaac072625c8093b2bcc0e277cf071f29cb3a9a9a40098be9afad4176eb30e4f3289ef5a8d8f73e12f1dba127a33b45dcbbf9138b04033fd804c42  linux-samsung-m33x-9c64f7aa866dca5a50dda6bd554601e80cf800e8.tar.gz
f2f619d8db1287af5a574d63aec09f1e9b5b683e8059f7c84f82a5e1232008d23fd273761fe58da8abe12e50e1417891b44a3b1cb2446a118a5f795350905363  config-samsung-m33x.aarch64
"
